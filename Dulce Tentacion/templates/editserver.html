{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Administraci√≥n de Productos</h1>
    <a href="/logout" style="float: right;">Cerrar Sesi√≥n</a>

    <h2>‚ûï Agregar Nuevo Producto</h2>
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="action" value="add">
        
        <label>Secci√≥n:</label>
        <select name="categoria_id" required>
            <option value="">-- Selecciona una secci√≥n --</option>
            {% for cat in categorias %}
            <option value="{{ cat.id }}">{{ cat.nombre }}</option>
            {% endfor %}
        </select>
        
        <br><br>
        <label>Nombre:</label>
        <input type="text" name="nombre" required>
        
        <br><br>
        <label>Descripci√≥n:</label>
        <textarea name="descripcion" rows="3"></textarea>
        
        <br><br>
        <label>Precio:</label>
        <input type="number" name="precio" required>
        
        <br><br>
        <label>Imagen:</label>
        <input type="file" name="imagen" accept="image/*">
        
        <br><br>
        <button type="submit">Guardar Producto</button>
    </form>

    <hr>
    <h2>üìã Productos Actuales</h2>
    
    {% if productos %}
    <table border="1" cellpadding="10" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>Imagen</th>
                <th>Producto</th>
                <th>Descripci√≥n</th>
                <th>Precio</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for p in productos %}
            <tr>
                <td style="width: 100px;">
                    {% if p.imagen %}
                        {% if p.imagen.startswith('http') %}
                            <img src="{{ p.imagen }}" alt="{{ p.nombre }}" style="width: 80px; height: 80px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/80x80.png?text=Error'">
                        {% else %}
                            <img src="/static/images/productos/{{ p.imagen }}" alt="{{ p.nombre }}" style="width: 80px; height: 80px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/80x80.png?text=Error'">
                        {% endif %}
                    {% else %}
                        <img src="https://via.placeholder.com/80x80.png?text=Sin+Imagen" alt="Sin imagen">
                    {% endif %}
                </td>
                <td>{{ p.nombre }}</td>
                <td>{{ p.descripcion }}</td>
                <td>${{ p.precio }}</td>
                <td>
                    <form method="POST" style="display: inline;">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="producto_id" value="{{ p.id }}">
                        <button type="submit" onclick="return confirm('¬øEliminar este producto?')">Eliminar</button>
                    </form>
                    <button onclick="editarProducto({{ p.id }}, '{{ p.nombre }}', '{{ p.descripcion }}', {{ p.precio }})">Editar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No hay productos agregados a√∫n.</p>
    {% endif %}
</div>

<!-- Modal de edici√≥n -->
<div id="modal-editar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; margin: 50px auto; padding: 30px; max-width: 500px; border-radius: 10px;">
        <h2>‚úèÔ∏è Editar Producto</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="producto_id" id="edit-id">
            
            <label>Nombre:</label>
            <input type="text" name="nombre" id="edit-nombre" required style="width: 100%; padding: 8px; margin: 10px 0;">
            
            <label>Descripci√≥n:</label>
            <textarea name="descripcion" id="edit-descripcion" rows="3" style="width: 100%; padding: 8px; margin: 10px 0;"></textarea>
            
            <label>Precio:</label>
            <input type="number" name="precio" id="edit-precio" required style="width: 100%; padding: 8px; margin: 10px 0;">
            
            <label>Nueva imagen (opcional):</label>
            <input type="file" name="imagen" accept="image/*" style="width: 100%; padding: 8px; margin: 10px 0;">
            
            <br><br>
            <button type="submit">Guardar Cambios</button>
            <button type="button" onclick="cerrarModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
function editarProducto(id, nombre, descripcion, precio) {
    document.getElementById('edit-id').value = id;
    document.getElementById('edit-nombre').value = nombre;
    document.getElementById('edit-descripcion').value = descripcion;
    document.getElementById('edit-precio').value = precio;
    document.getElementById('modal-editar').style.display = 'block';
}

function cerrarModal() {
    document.getElementById('modal-editar').style.display = 'none';
}
</script>
{% endblock %}
